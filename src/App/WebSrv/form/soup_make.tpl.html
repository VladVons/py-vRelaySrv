{% extends "Layout.tpl.html" %}

{% block head %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="/js/ajax.js"></script>
<script src="/js/TDbList.js"></script>
<script src="/js/Forms.js"></script>
<script>
    function BtnGetSchemeDone_OnClick() {
      HttpRequest(
          '/api/get_scheme_not_empty',
          function(aData) {
              console.log('aData', aData);
              ClearObj('input');
              ClearObj('textarea');

              let DbL = new TDbList(aData['Data']['Data']);
              //DbL.Shuffle();
              DbL.RecNo = 1;
              let Scheme = DbL.Rec.GetField('scheme');
              let SchemeJ = JSON.parse(Scheme);

              let Urls = SchemeJ['Product']['Info']['Url'];
              for (let i = 0; i < Urls.length; i++) {
                  document.getElementById('Url' + i).value = Urls[i];
              };

              let Pipe = '';
              let PipeJ = SchemeJ['Product']['Pipe'];
              for (let i = 0; i < PipeJ.length; i++) {
                if (PipeJ[i][0] == 'as_dict') {
                  Object.entries(PipeJ[i][1]).forEach(([Key, Val]) => {
                    let Script_Key = '';
                    Object.entries(Val).forEach(([Idx, Macro]) => {
                      Script_Key += JSON.stringify(Macro) + ',\n';
                    });
                    document.getElementById('Script_' + Key).value = Script_Key;
                  })
                } else {
                  Pipe += JSON.stringify(PipeJ[i]) + ',\n';
                };
              };

              document.getElementById('Pipe').value = Pipe;
              document.getElementById('Script').value = Scheme;
            },
          {'cnt': 10}
      );
    };

    function BtnGetSchemeEmpty2_OnClick(aId, aThis) {
        ClearObj('input');
        ClearObj('textarea');
        BtnGetSchemeEmpty_OnClick();
    }

    function BtnTest_OnClick(aId, aThis) {
        StartAt = Date.now();
        document.getElementById('Output').value = '';

        HttpRequest(
            '/api/get_scheme_test',
            function(aData) {
                console.log('aData', aData);
                document.getElementById('Output').value = JSON.stringify(aData, null, ' ');

                let Duration = (Date.now() - StartAt) / 1000;
                aThis.textContent = Duration.toFixed(2);
            },
            {'scheme': document.getElementById('Script').value}
        );
    };

    function SelHelp_OnClick(aThis) {
      let Val = aThis.options[aThis.selectedIndex].text;
      LastBlur.value += Val;
    }

    function BtnGo_OnClick() {
      let Items = document.getElementsByTagName('input');
      for (let i = 0; i < Items.length; i++) {
        if (Items[i].name.startsWith('Url')) {
          let Url = Items[i].value;
          window.open(Url, '_blank').focus();
        };
      };
    };

    function OnBlur(aThis) {
      LastBlur = aThis;
    }

</script>
{% endblock %}

{% block content %}
<form name="Form" method="post" action="/form/soup_make?action=go" enctype="multipart/form-data">
  <table style="width:100%">
  <tbody>
    <tr>
      <td style="width :5%">Url</td>
      <td style="width :40%">
        <input type="text" name="Url0" id="Url0" placeholder="url 1" style="width:100%" value="{{ Data.Url0 }}" required>
        <input type="text" name="Url1" id="Url1" placeholder="url 2" style="width:100%" value="{{ Data.Url1 }}">
      </td>
      <td>
        <button onclick="BtnGetSchemeEmpty2_OnClick()">get empty</button>
        <button onclick="BtnGetSchemeDone_OnClick()">get done</button>
        <button onclick="BtnGo_OnClick()">go</button>
        <input type="submit" name="BtnOk" value="make">
        <button onclick="BtnTest_OnClick()">test</button>
        <br>
        <select id="SelHelp" onclick="SelHelp_OnClick(this)">
          <optgroup label="- top -"></optgroup>
            <option>["equal", ["str1|str2"]]</option>
            <option>["find_all", ["li"]]</option>
            <option>["find", ["div", {"class": "content"}]]</option>
            <option>["image"]</option>
            <option>["list", [1]]</option>
            <option>["price"]</option>
            <option>["split", [":", 1]]</option>
            <option>["stock"]</option>
            <option>["strip"]</option>
            <option>["text"]</option>
            <option>["txt2json"]</option>
            <option>["unbracket", ["()", -1]]</option>
          </optgroup>
          <optgroup label="- misc -"></optgroup>
            <option>["as_dict", {"key1": [macros1], "key2": [macros2]}</option>
            <option>["as_if", {"cond": [...], "true": [...], "false:[...]"}</option>
            <option>["as_list", [[macros1],[macros2]]</option>
            <option>["help"]</option>
          </optgroup>
        </select>
      </td>
    </tr>
    <tr>
      <td>Pipe</td>
      <td>
        <textarea name="Pipe" id="Pipe" rows="3" onblur="OnBlur(this)" required>{{ Data.Pipe }}</textarea>
      </td>
      <td rowspan="7">
        <textarea name="Script" id="Script" rows="20">{{ Data.Script }}</textarea>
        <textarea readonly name="Output" id="Output" rows="20">{{ Data.Output }}</textarea>
      </td>
    </tr>
    <tr>
      <td>Name</td>
      <td>
        <textarea name="Script_Name" id="Script_Name" rows="4" onblur="OnBlur(this)">{{ Data.Script_Name }}</textarea>
      </td>
    </tr>
    <tr>
      <td>Price</td>
      <td>
        <textarea name="Script_Price" id="Script_Price" rows="4" onblur="OnBlur(this)">{{ Data.Script_Price }}</textarea>
      </td>
    </tr>
    <tr>
      <td>Price_old</td>
      <td>
        <textarea name="Script_PriceOld" id="Script_PriceOld" rows="4" onblur="OnBlur(this)">{{ Data.Script_PriceOld }}</textarea>
      </td>
    </tr>
    <tr>
      <td>Stock</td>
      <td>
        <textarea name="Script_Stock" id="Script_Stock" rows="4" onblur="OnBlur(this)">{{ Data.Script_Stock }}</textarea>
      </td>
    </tr>
    <tr>
      <td>Image</td>
      <td>
        <textarea name="Script_Image" id="Script_Image" rows="4" onblur="OnBlur(this)">{{ Data.Script_Image }}</textarea>
      </td>
    </tr>
    <tr>
      <td>MPN</td>
      <td>
        <textarea name="Script_MPN" id="Script_MPN" rows="4" onblur="OnBlur(this)">{{ Data.Script_MPN }}</textarea>
      </td>
    </tr>
    <tr>
      <td>Make</td>
      <td>
      </td>
      <td>
        <button onclick="BtnSchemeGetEmpty2_OnClick()">get empty</button>
        <button onclick="BtnSchemeGetDone_OnClick()">get done</button>
        <button onclick="BtnGo_OnClick()">go</button>
        <input type="submit" name="BtnOk" value="make">
        <button onclick="BtnTest_OnClick()">test</button>
      </td>
    </tr>
  </tbody>
  </table>
</form>
{% endblock %}
